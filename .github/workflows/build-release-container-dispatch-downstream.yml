name: Build Release Container and Dispatch to Downstream

on:
  push:
    branches:
      - "features-based-on-v*"
  workflow_dispatch:
    inputs:
      branch_name:
        description: "Feature branch name to deploy"
        required: true
        type: string

env:
  REGISTRY: ord.ocir.io
  REGISTRY_NAMESPACE: idqj093njucb
  K8S_NAMESPACE: github-actions
  CONTAINER_NAME: official-sgl

jobs:
  build:
    if: |
      (github.event_name == 'push' && startsWith(github.ref_name, 'features-based-on-v')) ||
      (github.event_name == 'workflow_dispatch' && startsWith(github.event.inputs.branch_name, 'features-based-on-v'))
    runs-on: ubuntu-24.04-4core-16gb
    # runs-on: self-hosted
    permissions:
      contents: read
      packages: write
      id-token: write
    outputs:
      image_name: ${{ steps.version_info.outputs.image_name }}
      full_tag: ${{ steps.version_info.outputs.full_tag }}
      branch_name: ${{ steps.version_info.outputs.branch_name }}
      version: ${{ steps.version_info.outputs.version }}
      commit_hash: ${{ steps.version_info.outputs.commit_hash }}
    strategy:
      matrix:
        variant:
          - cuda_version: "12.9.1"
            build_type: "all"
            grace_blackwell: 0
            branch_type: "local"

    steps:
      - name: Delete huge unnecessary tools folder
        run: rm -rf /opt/hostedtoolcache

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.branch_name || github.ref_name }}

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          docker-images: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.OCIR_ACCOUNT }}
          password: ${{ secrets.OCIR_TOKEN }}

      - name: Extract version and commit info
        id: version_info
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BRANCH_NAME="${{ github.event.inputs.branch_name }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi

          # Extract version from branch name (features-based-on-vX.Y.Z -> vX.Y.Z)
          VERSION=$(echo "$BRANCH_NAME" | sed 's/features-based-on-//')

          # Get short commit hash
          COMMIT_HASH=$(git rev-parse --short HEAD)

          if [ "${{ matrix.variant.cuda_version }}" = "12.9.1" ]; then
            CUDA_SUFFIX="cu129"
          else
            echo "Unsupported CUDA version"
            exit 1
          fi

          if [ "${{ matrix.variant.build_type }}" = "all" ]; then
            TAG_SUFFIX=""
          else
            echo "Unsupported build type"
            exit 1
          fi

          # Create full tag
          FULL_TAG="${VERSION}.${COMMIT_HASH}-${CUDA_SUFFIX}${TAG_SUFFIX}"

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "full_tag=$FULL_TAG" >> $GITHUB_OUTPUT
          echo "image_name=${REGISTRY}/${REGISTRY_NAMESPACE}/${CONTAINER_NAME}" >> $GITHUB_OUTPUT

          echo "Branch: $BRANCH_NAME"
          echo "Version: $VERSION"
          echo "Commit: $COMMIT_HASH"
          echo "Full tag: $FULL_TAG"

      - name: Build and push Docker image for AMD64 Runtime
        run: |
          image_tag=${{ steps.version_info.outputs.image_name }}:${{ steps.version_info.outputs.full_tag }}

          docker buildx build \
            --target runtime \
            --platform linux/amd64 \
            --push \
            -f docker/Dockerfile \
            --build-arg CUDA_VERSION=${{ matrix.variant.cuda_version }} \
            --build-arg BUILD_TYPE=${{ matrix.variant.build_type }} \
            --build-arg GRACE_BLACKWELL=${{ matrix.variant.grace_blackwell }} \
            --build-arg INSTALL_FLASHINFER_JIT_CACHE=1 \
            --build-arg SGL_VERSION=${{ steps.version_info.outputs.version }} \
            --build-arg BRANCH_TYPE=${{ matrix.variant.branch_type }} \
            -t ${image_tag} \
            --no-cache \
            .

  dispatch:
    runs-on: ubuntu-latest
    needs: [build]
    permissions:
      contents: write
    steps:
      - name: Repository Dispatch
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.OME_TOKEN }}
          repository: sgl-project/ome
          event-type: container-pushed
          client-payload: |-
            {
              "image_name": "${{ needs.build.outputs.image_name }}",
              "full_tag": "${{ needs.build.outputs.full_tag }}",
              "branch_name": "${{ needs.build.outputs.branch_name }}",
              "version": "${{ needs.build.outputs.version }}",
              "commit_hash": "${{ needs.build.outputs.commit_hash }}"
            }
